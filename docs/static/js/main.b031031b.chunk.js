(this["webpackJsonpstravastat.github.io"]=this["webpackJsonpstravastat.github.io"]||[]).push([[0],{134:function(e,t,r){e.exports={form:"styles_form__3wXzo"}},139:function(e,t,r){},140:function(e,t,r){},442:function(e,t,r){"use strict";r.r(t);var n=r(2),a=r.n(n),c=r(17),o=r.n(c),s=(r(139),r(6)),i=r.n(s),u=r(21),l=r(22),p=(r(140),r(135)),h=["athlete"],d=59766,f="b7893c2f78225337f8ac6852e5c2fe313948c8f7",v="SportSeasonStravaTokenData",j="SportSeasonStravaUserData";function b(){var e={client_id:d,redirect_uri:window.location.origin,response_type:"code",approval_prompt:"auto",scope:"activity:read"},t=new URLSearchParams(e);return"https://www.strava.com/oauth/authorize?".concat(t.toString())}function m(){return g.apply(this,arguments)}function g(){return(g=Object(u.a)(i.a.mark((function e(){var t,r,n;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(t=localStorage.getItem(v))||!t.length){e.next=20;break}if(!((r=JSON.parse(t)).expires_at&&1e3*r.expires_at>Date.now())){e.next=5;break}return e.abrupt("return",r.access_token);case 5:if(!r.refresh_token){e.next=17;break}return e.prev=6,e.next=9,fetch("https://www.strava.com/api/v3/oauth/token",{body:new URLSearchParams({client_id:d,client_secret:f,refresh_token:r.refresh_token,grant_type:"refresh_token"}).toString(),headers:{"Content-Type":"application/x-www-form-urlencoded"},method:"POST"}).then((function(e){return e.json()}));case 9:return n=e.sent,localStorage.setItem(v,JSON.stringify(n)),e.abrupt("return",n.access_token);case 14:throw e.prev=14,e.t0=e.catch(6),new Error(e.t0);case 17:throw new Error("no token");case 20:throw new Error("no stored token data");case 21:case"end":return e.stop()}}),e,null,[[6,14]])})))).apply(this,arguments)}function w(e){return O.apply(this,arguments)}function O(){return(O=Object(u.a)(i.a.mark((function e(t){var r,n,a;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,fetch("https://www.strava.com/api/v3/oauth/token",{body:new URLSearchParams({client_id:d,client_secret:f,code:t,grant_type:"authorization_code"}).toString(),headers:{"Content-Type":"application/x-www-form-urlencoded"},method:"POST"}).then((function(e){return e.json()}));case 3:return r=e.sent,console.log({result:r}),n=r.athlete,a=Object(p.a)(r,h),localStorage.setItem(j,JSON.stringify(n)),localStorage.setItem(v,JSON.stringify(a)),e.abrupt("return",r.access_token);case 11:throw e.prev=11,e.t0=e.catch(0),new Error(e.t0);case 14:case"end":return e.stop()}}),e,null,[[0,11]])})))).apply(this,arguments)}function _(){return(_=Object(u.a)(i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return"",e.prev=1,e.next=4,fetch("https://www.strava.com/oauth/deauthorize?".concat(new URLSearchParams({access_token:""}).toString()),{method:"POST"}).then((function(e){return e.json()}));case 4:return localStorage.removeItem(v),localStorage.removeItem(j),e.abrupt("return",Promise.resolve({success:!0}));case 9:throw e.prev=9,e.t0=e.catch(1),new Error(e.t0);case 12:case"end":return e.stop()}}),e,null,[[1,9]])})))).apply(this,arguments)}var x=r(57),S=r.n(x),y=r(1),k=function(e){var t=JSON.parse(localStorage.getItem(j));return Object(y.jsxs)("div",{className:S.a.prof,children:[Object(y.jsx)("img",{src:t.profile_medium,className:S.a.ava}),Object(y.jsxs)("div",{className:S.a.name,children:[t.lastname,Object(y.jsx)("strong",{children:t.firstname})]})]})},D=r(56),I=r(84),T=r(45),L=r(131),N=r.n(L);function C(){return(C=Object(u.a)(i.a.mark((function e(t,r,n){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,fetch("https://www.strava.com/api/v3/athlete/activities?before=".concat(n,"&after=").concat(r,"&page=1&per_page=100"),{headers:{Authorization:"Bearer ".concat(t)}}).then((function(e){return e.json()}));case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)})))).apply(this,arguments)}r(142);function E(e){return e>0?e>1e3?"".concat(parseFloat(e/1e3).toFixed(2),"\u202f\u043a\u043c"):"".concat(parseFloat(e).toFixed(),"\u2009\u043c"):"-"}var P=function(e){var t=e.activity,r=Date.parse(t.start_date_local)-1e3*t.utc_offset,n=new Date(r),a=new Date(r+1e3*t.elapsed_time),c=new Date(1e3*(t.moving_time-t.utc_offset));return Object(y.jsxs)("div",{children:[Object(y.jsx)("a",{href:"https://www.strava.com/activities/".concat(t.id),target:"_blank",children:t.name}),Object(y.jsx)("strong",{children:E(t.distance)}),n.toLocaleString().substr(0,17),"-",n.toLocaleDateString()!==a.toLocaleDateString()&&a.toLocaleDateString(),a.toLocaleTimeString().substr(0,5),"(\u0434\u0432\u0438\u0436: ",c.toLocaleTimeString().substr(0,5),")",Object(y.jsx)("br",{}),t.elev_high,"/",t.elev_low," ",t.average_heartrate,"/",t.max_heartrate," ",t.average_speed,"/",t.speed]})};var F,J=r(58),R=r.n(J),z=function(e){var t=e.title,r=e.children;return Object(y.jsxs)("div",{className:R.a.card,children:[Object(y.jsx)("div",{className:R.a.cardTitle,children:t}),Object(y.jsx)("div",{className:R.a.cardContent,children:r})]})},A=r(134),U=r.n(A),B=new Date,M=new Date(B.getFullYear(),0,1,4,0,0,1),Y=new Date(B.getFullYear(),11,31,23,59,59,999),q=function(e){var t=e.token,r=Object(n.useState)(localStorage.getItem("stravastatD1")||M.toISOString().substr(0,10)),a=Object(l.a)(r,2),c=a[0],o=a[1],s=Object(n.useState)(localStorage.getItem("stravastatD2")||Y.toISOString().substr(0,10)),i=Object(l.a)(s,2),u=i[0],p=i[1],h=Object(n.useState)([]),d=Object(l.a)(h,2),f=d[0],v=d[1],j=Object(n.useState)(localStorage.getItem("stravastatType")),b=Object(l.a)(j,2),m=b[0],g=b[1],w=Object(n.useState)(null),O=Object(l.a)(w,2),_=O[0],x=O[1],S=Object(n.useRef)(),k=Object(n.useRef)();Object(n.useEffect)((function(){clearTimeout(F),F=setTimeout((function(){x(null),localStorage.setItem("stravastatD1",c),localStorage.setItem("stravastatD2",u),function(e,t,r){return C.apply(this,arguments)}(t,Math.floor(Date.parse(c)/1e3),Math.floor(Date.parse(u)/1e3)).then((function(e){x(e),v(e.reduce((function(e,t){var r=t.type;return Object(I.a)(Object(I.a)({},e),{},Object(D.a)({},r,(e[r]||0)+1))}),{})),console.log(e)}))}),600)}),[c,u,t]),Object(n.useEffect)((function(){localStorage.setItem("stravastatType",m)}),[m]),Object(n.useEffect)((function(){if(null===k||void 0===k?void 0:k.current){(null===S||void 0===S?void 0:S.current)||(S.current=T.map(k.current,{fullscreenControl:!0}).setView([53.20066,45.00464],12),T.tileLayer("http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'Map data \xa9 <a href="http://openstreetmap.org">OpenStreetMap</a> contributors',maxZoom:20,id:"osm"}).addTo(S.current));var e,t=[];(e=S.current).eachLayer((function(t){var r=!(t.getAttribution&&t.getAttribution()),n=!t.getAttribution;(r||n)&&e.removeLayer(t)})),_.filter((function(e){return!m||e.type===m})).forEach((function(e){var r=e.map.summary_polyline;if(null===r||void 0===r?void 0:r.length){var n=N.a.decode(r);T.polyline(n).setStyle({color:"rgba(255, 0, 0,0.5)"}).addTo(S.current),t.push(n)}}));var r=T.latLngBounds(t);(null===t||void 0===t?void 0:t.length)&&S.current.fitBounds(r)}}),[k.current,_,m]);var L=_&&_.filter((function(e){return!m||e.type===m})).reduce((function(e,t){return{distance:e.distance+t.distance,elev_high:e.elev_high+t.elev_high||0,elev_low:e.elev_low+t.elev_low||0,elapsed_time:e.elapsed_time+t.elapsed_time,moving_time:e.moving_time+t.moving_time}}),{distance:0,elev_high:0,elev_low:0,elapsed_time:0,moving_time:0});return Object(y.jsxs)("div",{children:[Object(y.jsxs)("div",{className:U.a.form,children:[Object(y.jsx)("input",{type:"date",value:c,onChange:function(e){return o(e.target.value)}}),"-",Object(y.jsx)("input",{type:"date",value:u,max:Y.toISOString().substr(0,10),onChange:function(e){return p(e.target.value)}})," \xa0 ",Object(y.jsxs)("select",{onChange:function(e){return g(e.target.value)},value:m,children:[Object(y.jsx)("option",{value:"",children:"\u0412\u0441\u0435 \u0432\u0438\u0434\u044b \u0430\u043a\u0442\u0438\u0432\u043d\u043e\u0441\u0442\u0435\u0439"}),f&&Object.entries(f).map((function(e){var t=Object(l.a)(e,2),r=t[0],n=t[1];return Object(y.jsxs)("option",{value:r,children:[r," (",n,")"]},r)}))]})]}),L&&Object(y.jsxs)("section",{style:{display:"flex",margin:"10px auto"},children:[Object(y.jsx)(z,{title:"\u0414\u0438\u0441\u0442\u0430\u043d\u0446\u0438\u044f",children:E(L.distance)}),Object(y.jsx)(z,{title:"\u041d\u0430\u0431\u043e\u0440",children:E(L.elev_high)}),Object(y.jsx)(z,{title:"\u0421\u0431\u0440\u043e\u0441",children:E(L.elev_low)}),Object(y.jsxs)(z,{title:"\u0412 \u0434\u0432\u0438\u0436\u0435\u043d\u0438\u0438",children:[(L.moving_time/60/60).toFixed(2)," \u0447"]})]}),!_&&"loading...",_&&Object(y.jsx)("div",{ref:k,style:{height:"300px"}}),Object(y.jsx)("ul",{children:_&&_.filter((function(e){return!m||e.type===m})).map((function(e){return Object(y.jsx)(P,{activity:e},e.id)}))})]})};var H=function(){var e=Object(n.useState)(null),t=Object(l.a)(e,2),r=t[0],a=t[1];return Object(n.useEffect)((function(){var e=new URLSearchParams(window.location.search).get("code");if(null===e||void 0===e?void 0:e.length)return function(){var t=Object(u.a)(i.a.mark((function t(){return i.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,w(e);case 3:window.location.href=window.location.href.replace(window.location.search,""),t.next=9;break;case 6:t.prev=6,t.t0=t.catch(0),window.location.href=b();case 9:case"end":return t.stop()}}),t,null,[[0,6]])})));return function(){return t.apply(this,arguments)}}()();(function(){var e=Object(u.a)(i.a.mark((function e(){var t;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,m();case 3:t=e.sent,a(t),e.next=10;break;case 7:e.prev=7,e.t0=e.catch(0),console.log(e.t0);case 10:case"end":return e.stop()}}),e,null,[[0,7]])})));return function(){return e.apply(this,arguments)}})()()}),[]),Object(y.jsxs)("div",{className:"App",children:[r&&Object(y.jsxs)("header",{className:"header",children:[Object(y.jsx)(k,{}),Object(y.jsx)("button",{onClick:function(){return function(){return _.apply(this,arguments)}().then((function(){return window.location.reload()}))},children:"\u0412\u044b\u0439\u0442\u0438"})]}),!r&&Object(y.jsx)("button",{onClick:function(){return window.location.href=b()},children:"\u0412\u043e\u0439\u0442\u0438"}),r&&Object(y.jsx)(q,{token:r})]})};o.a.render(Object(y.jsx)(a.a.StrictMode,{children:Object(y.jsx)(H,{})}),document.getElementById("root"))},57:function(e,t,r){e.exports={ava:"styles_ava__3uCq3",prof:"styles_prof__xcgdj",name:"styles_name__LOOD9"}},58:function(e,t,r){e.exports={card:"styles_card__2aJrc",cardTitle:"styles_cardTitle__QB308",cardContent:"styles_cardContent__77HFA"}}},[[442,1,2]]]);
//# sourceMappingURL=main.b031031b.chunk.js.map