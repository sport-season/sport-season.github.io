(this["webpackJsonpstravastat.github.io"]=this["webpackJsonpstravastat.github.io"]||[]).push([[0],{145:function(e,t,a){},146:function(e,t,a){},448:function(e,t,a){"use strict";a.r(t);var r=a(2),n=a.n(r),c=a(18),o=a.n(c),i=(a(145),a(3)),s=a.n(i),u=a(7),l=a(19),d=(a(146),a(141)),h=["athlete"],p=59766,v="b7893c2f78225337f8ac6852e5c2fe313948c8f7",f="SportSeasonStravaTokenData",b="SportSeasonStravaUserData";function j(){var e={client_id:p,redirect_uri:window.location.origin,response_type:"code",approval_prompt:"auto",scope:"activity:read"},t=new URLSearchParams(e);return"https://www.strava.com/oauth/authorize?".concat(t.toString())}function m(){return g.apply(this,arguments)}function g(){return(g=Object(u.a)(s.a.mark((function e(){var t,a,r;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(t=localStorage.getItem(f))||!t.length){e.next=20;break}if(!((a=JSON.parse(t)).expires_at&&1e3*a.expires_at>Date.now())){e.next=5;break}return e.abrupt("return",a.access_token);case 5:if(!a.refresh_token){e.next=17;break}return e.prev=6,e.next=9,fetch("https://www.strava.com/api/v3/oauth/token",{body:new URLSearchParams({client_id:p,client_secret:v,refresh_token:a.refresh_token,grant_type:"refresh_token"}).toString(),headers:{"Content-Type":"application/x-www-form-urlencoded"},method:"POST"}).then((function(e){return e.json()}));case 9:return r=e.sent,localStorage.setItem(f,JSON.stringify(r)),e.abrupt("return",r.access_token);case 14:throw e.prev=14,e.t0=e.catch(6),new Error(e.t0);case 17:throw new Error("no token");case 20:throw new Error("no stored token data");case 21:case"end":return e.stop()}}),e,null,[[6,14]])})))).apply(this,arguments)}function w(e){return O.apply(this,arguments)}function O(){return(O=Object(u.a)(s.a.mark((function e(t){var a,r,n;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,fetch("https://www.strava.com/api/v3/oauth/token",{body:new URLSearchParams({client_id:p,client_secret:v,code:t,grant_type:"authorization_code"}).toString(),headers:{"Content-Type":"application/x-www-form-urlencoded"},method:"POST"}).then((function(e){return e.json()}));case 3:return a=e.sent,console.log({result:a}),r=a.athlete,n=Object(d.a)(a,h),localStorage.setItem(b,JSON.stringify(r)),localStorage.setItem(f,JSON.stringify(n)),e.abrupt("return",a.access_token);case 11:throw e.prev=11,e.t0=e.catch(0),new Error(e.t0);case 14:case"end":return e.stop()}}),e,null,[[0,11]])})))).apply(this,arguments)}function _(){return(_=Object(u.a)(s.a.mark((function e(){return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return"",e.prev=1,e.next=4,fetch("https://www.strava.com/oauth/deauthorize?".concat(new URLSearchParams({access_token:""}).toString()),{method:"POST"}).then((function(e){return e.json()}));case 4:return localStorage.removeItem(f),localStorage.removeItem(b),e.abrupt("return",Promise.resolve({success:!0}));case 9:throw e.prev=9,e.t0=e.catch(1),new Error(e.t0);case 12:case"end":return e.stop()}}),e,null,[[1,9]])})))).apply(this,arguments)}function x(){return JSON.parse(localStorage.getItem(b))}var y=a(60),S=a.n(y),k=a(1),D=function(e){var t=x();return Object(k.jsxs)("div",{className:S.a.prof,children:[Object(k.jsx)("img",{src:t.profile_medium,className:S.a.ava}),Object(k.jsxs)("div",{className:S.a.name,children:[t.lastname,Object(k.jsx)("strong",{children:t.firstname})]})]})},A=a(59),I=a(23),L=a(47),T=a(134),C=a.n(T),N=a(140),E=a(135),P=a(136),B=a(139),z=new(function(){function e(t,a){Object(E.a)(this,e),this.init(t,a)}return Object(P.a)(e,[{key:"init",value:function(){var e=Object(u.a)(s.a.mark((function e(t,a){return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Object(B.a)(t,a,{upgrade:function(e){e.createObjectStore("activities",{keyPath:"id"}).createIndex("start_date","start_date")}});case 2:this.db=e.sent;case 3:case"end":return e.stop()}}),e,this)})));return function(t,a){return e.apply(this,arguments)}}()},{key:"addActivities",value:function(e){var t=this.db.transaction("activities","readwrite");t.objectStore("activities");return Array.isArray(e)?Promise.all([].concat(Object(N.a)(e.map((function(e){return t.store.add(e)}))),[t.done])):t.add("activities",e)}},{key:"getAllActivity",value:function(){return this.db.transaction("activities").objectStore("activities").getAll()}}]),e}())("stravastat",1);function F(e,t,a){return J.apply(this,arguments)}function J(){return(J=Object(u.a)(s.a.mark((function e(t,a,r){var n,c,o=arguments;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=o.length>3&&void 0!==o[3]?o[3]:1,c=o.length>4&&void 0!==o[4]?o[4]:100,e.next=4,fetch("https://www.strava.com/api/v3/athlete/activities?before=".concat(r,"&after=").concat(a,"&page=").concat(n,"&per_page=").concat(c),{headers:{Authorization:"Bearer ".concat(t)}}).then((function(e){return e.json()}));case 4:return e.abrupt("return",e.sent);case 5:case"end":return e.stop()}}),e)})))).apply(this,arguments)}a(148);function M(e){return e>0?e>1e3?"".concat(parseFloat(e/1e3).toFixed(2),"\u202f\u043a\u043c"):"".concat(parseFloat(e).toFixed(),"\u2009\u043c"):"-"}var R=function(e){var t=e.activity,a=Date.parse(t.start_date_local)-1e3*t.utc_offset,r=new Date(a),n=new Date(a+1e3*t.elapsed_time),c=new Date(1e3*(t.moving_time-t.utc_offset));return Object(k.jsxs)("div",{children:[Object(k.jsx)("a",{href:"https://www.strava.com/activities/".concat(t.id),target:"_blank",children:t.name}),Object(k.jsx)("strong",{children:M(t.distance)}),r.toLocaleString().substr(0,17),"-",r.toLocaleDateString()!==n.toLocaleDateString()&&n.toLocaleDateString(),n.toLocaleTimeString().substr(0,5),"(\u0434\u0432\u0438\u0436: ",c.toLocaleTimeString().substr(0,5),")",Object(k.jsx)("br",{}),t.elev_high,"/",t.elev_low," ",t.average_heartrate,"/",t.max_heartrate," ",t.average_speed,"/",t.speed]})};var U=a(61),H=a.n(U),Y=function(e){var t=e.title,a=e.children;return Object(k.jsxs)("div",{className:H.a.card,children:[Object(k.jsx)("div",{className:H.a.cardTitle,children:t}),Object(k.jsx)("div",{className:H.a.cardContent,children:a})]})},q=a(88),G=a.n(q),Q=Object(r.createContext)(null),V=new Date,W=new Date(V.getFullYear(),0,1,4,0,0,1),X=new Date(V.getFullYear(),11,31,23,59,59,999),Z=function(e){var t=e.token,a=Object(r.useState)(localStorage.getItem("stravastatD1")||W.toISOString().substr(0,10)),n=Object(l.a)(a,2),c=n[0],o=n[1],i=Object(r.useState)(localStorage.getItem("stravastatD2")||X.toISOString().substr(0,10)),d=Object(l.a)(i,2),h=d[0],p=d[1],v=Object(r.useState)([]),f=Object(l.a)(v,2),b=f[0],j=f[1],m=Object(r.useState)(!1),g=Object(l.a)(m,2),w=g[0],O=g[1],_=Object(r.useState)(localStorage.getItem("stravastatType")),x=Object(l.a)(_,2),y=x[0],S=x[1],D=Object(r.useState)(null),T=Object(l.a)(D,2),N=T[0],E=T[1],P=Object(r.useRef)(),B=Object(r.useRef)(),J=Object(r.useContext)(Q);Object(r.useEffect)((function(){z.getAllActivity().then((function(e){console.log(e),E(e)}))}),[]),Object(r.useEffect)((function(){return localStorage.setItem("stravastatD1",c)}),[c]),Object(r.useEffect)((function(){return localStorage.setItem("stravastatD2",h)}),[h]),Object(r.useEffect)((function(){return localStorage.setItem("stravastatType",y)}),[y]),Object(r.useEffect)((function(){(null===N||void 0===N?void 0:N.length)&&j(N.reduce((function(e,t){var a=t.type;return Object(I.a)(Object(I.a)({},e),{},Object(A.a)({},a,(e[a]||0)+1))}),{}))}),[N]),Object(r.useEffect)((function(){if(null===B||void 0===B?void 0:B.current){(null===P||void 0===P?void 0:P.current)||(P.current=L.map(B.current,{fullscreenControl:!0}).setView([53.20066,45.00464],12),L.tileLayer("http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'Map data \xa9 <a href="http://openstreetmap.org">OpenStreetMap</a> contributors',maxZoom:20,id:"osm"}).addTo(P.current));var e,t=[];(e=P.current).eachLayer((function(t){var a=!(t.getAttribution&&t.getAttribution()),r=!t.getAttribution;(a||r)&&e.removeLayer(t)}));var a=N&&N.filter((function(e){var t=Date.parse(e.start_date_local),a=Date.parse(c),r=Date.parse(h);return(!y||e.type===y)&&t>=a&&t<=r}));null===a||void 0===a||a.forEach((function(e){var a=e.map.summary_polyline;if(null===a||void 0===a?void 0:a.length){var r=C.a.decode(a);L.polyline(r).setStyle({color:"rgba(255, 0, 0,0.5)"}).addTo(P.current),t.push(r)}}));var r=L.latLngBounds(t);(null===t||void 0===t?void 0:t.length)&&P.current.fitBounds(r)}}),[B.current,N,y,c,h]);var U=N&&N.filter((function(e){var t=Date.parse(e.start_date_local),a=Date.parse(c),r=Date.parse(h);return(!y||e.type===y)&&t>=a&&t<=r})),H=null===U||void 0===U?void 0:U.reduce((function(e,t){return{distance:e.distance+t.distance,elev_high:e.elev_high+t.elev_high||0,elev_low:e.elev_low+t.elev_low||0,elapsed_time:e.elapsed_time+t.elapsed_time,moving_time:e.moving_time+t.moving_time}}),{distance:0,elev_high:0,elev_low:0,elapsed_time:0,moving_time:0}),q=function(){var e=Object(u.a)(s.a.mark((function e(){var a,r,n,c,o;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:O(!0),n=(null===(a=r=N)||void 0===a?void 0:a.length)?new Date(Date.parse(r[r.length-1].start_date)):new Date(Date.parse(J.created_at)),c=0;case 4:if(!(0===c||(null===(o=r)||void 0===o?void 0:o.length)>0)){e.next=16;break}return c++,console.log("page",c),e.next=9,F(t,Math.floor(n.getTime()/1e3),Math.floor((new Date).getTime()/1e3),c,50);case 9:return r=e.sent,console.time("addDB"),e.next=13,z.addActivities(r).catch((function(e){return console.error(e)}));case 13:console.timeEnd("addDB"),e.next=4;break;case 16:O(!1);case 17:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}();return Object(k.jsxs)("div",{children:[Object(k.jsx)("button",{className:G.a.floatButton,disabled:w,onClick:q,children:Object(k.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",fill:"currentColor",className:"bi bi-arrow-repeat",viewBox:"0 0 16 16",children:[Object(k.jsx)("path",{d:"M11.534 7h3.932a.25.25 0 0 1 .192.41l-1.966 2.36a.25.25 0 0 1-.384 0l-1.966-2.36a.25.25 0 0 1 .192-.41zm-11 2h3.932a.25.25 0 0 0 .192-.41L2.692 6.23a.25.25 0 0 0-.384 0L.342 8.59A.25.25 0 0 0 .534 9z"}),Object(k.jsx)("path",{"fill-rule":"evenodd",d:"M8 3c-1.552 0-2.94.707-3.857 1.818a.5.5 0 1 1-.771-.636A6.002 6.002 0 0 1 13.917 7H12.9A5.002 5.002 0 0 0 8 3zM3.1 9a5.002 5.002 0 0 0 8.757 2.182.5.5 0 1 1 .771.636A6.002 6.002 0 0 1 2.083 9H3.1z"})]})}),Object(k.jsxs)("div",{className:G.a.form,children:[Object(k.jsx)("input",{type:"date",value:c,min:J.created_at.substr(0,10),max:h.substr(0,10),onChange:function(e){return o(e.target.value)}}),"-",Object(k.jsx)("input",{type:"date",value:h,min:c.substr(0,10),max:(new Date).toISOString().substr(0,10),onChange:function(e){return p(e.target.value)}})," \xa0 ",Object(k.jsxs)("select",{onChange:function(e){return S(e.target.value)},value:y,children:[Object(k.jsx)("option",{value:"",children:"\u0412\u0441\u0435 \u0432\u0438\u0434\u044b \u0430\u043a\u0442\u0438\u0432\u043d\u043e\u0441\u0442\u0435\u0439"}),b&&Object.entries(b).map((function(e){var t=Object(l.a)(e,2),a=t[0],r=t[1];return Object(k.jsxs)("option",{value:a,children:[a," (",r,")"]},a)}))]})]}),H&&Object(k.jsxs)("section",{style:{display:"flex",margin:"10px auto"},children:[Object(k.jsx)(Y,{title:"\u0414\u0438\u0441\u0442\u0430\u043d\u0446\u0438\u044f",children:M(H.distance)}),Object(k.jsx)(Y,{title:"\u041d\u0430\u0431\u043e\u0440",children:M(H.elev_high)}),Object(k.jsx)(Y,{title:"\u0421\u0431\u0440\u043e\u0441",children:M(H.elev_low)}),Object(k.jsxs)(Y,{title:"\u0412 \u0434\u0432\u0438\u0436\u0435\u043d\u0438\u0438",children:[(H.moving_time/60/60).toFixed(2)," \u0447"]})]}),!N&&"loading...",U&&Object(k.jsx)("div",{ref:B,style:{height:"300px"}}),Object(k.jsx)("ul",{children:U&&U.map((function(e){return Object(k.jsx)(R,{activity:e},e.id)}))})]})};var K=function(){var e=Object(r.useState)(null),t=Object(l.a)(e,2),a=t[0],n=t[1];return Object(r.useEffect)((function(){var e=new URLSearchParams(window.location.search).get("code");if(null===e||void 0===e?void 0:e.length)return function(){var t=Object(u.a)(s.a.mark((function t(){return s.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,w(e);case 3:window.location.href=window.location.href.replace(window.location.search,""),t.next=9;break;case 6:t.prev=6,t.t0=t.catch(0),window.location.href=j();case 9:case"end":return t.stop()}}),t,null,[[0,6]])})));return function(){return t.apply(this,arguments)}}()();(function(){var e=Object(u.a)(s.a.mark((function e(){var t;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,m();case 3:t=e.sent,n(t),e.next=10;break;case 7:e.prev=7,e.t0=e.catch(0),console.log(e.t0);case 10:case"end":return e.stop()}}),e,null,[[0,7]])})));return function(){return e.apply(this,arguments)}})()()}),[]),Object(k.jsxs)("div",{className:"App",children:[a&&Object(k.jsxs)(Q.Provider,{value:x(),children:[Object(k.jsxs)("header",{className:"header",children:[Object(k.jsx)(D,{}),Object(k.jsx)("button",{onClick:function(){return function(){return _.apply(this,arguments)}().then((function(){return window.location.reload()}))},children:"\u0412\u044b\u0439\u0442\u0438"})]}),Object(k.jsx)(Z,{token:a})]}),!a&&Object(k.jsx)("button",{onClick:function(){return window.location.href=j()},children:"\u0412\u043e\u0439\u0442\u0438"})]})};o.a.render(Object(k.jsx)(n.a.StrictMode,{children:Object(k.jsx)(K,{})}),document.getElementById("root"))},60:function(e,t,a){e.exports={ava:"styles_ava__3uCq3",prof:"styles_prof__xcgdj",name:"styles_name__LOOD9"}},61:function(e,t,a){e.exports={card:"styles_card__2aJrc",cardTitle:"styles_cardTitle__QB308",cardContent:"styles_cardContent__77HFA"}},88:function(e,t,a){e.exports={form:"styles_form__3wXzo",floatButton:"styles_floatButton__k3PFU",rotation:"styles_rotation__RGWBT"}}},[[448,1,2]]]);
//# sourceMappingURL=main.dd8139c1.chunk.js.map